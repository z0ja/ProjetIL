<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../assets/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link href="../assets/css/styles.css" rel="stylesheet" crossorigin="anonymous">
    <link href="../assets/css/bootstrap-icons.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100;200;400;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #fcfcfc; }
        
        .navbar { margin-bottom: 20px; border-bottom: 1px solid #eee; }
        
        /* Zone Vid√©o */
        #video-container {
            width: 100%;
            aspect-ratio: 16/9;
            background-color: #000;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            overflow: hidden;
            position: relative;
        }
        
        #video-iframe { width: 100%; height: 100%; border: none; }

        /* Contr√¥les */
        .controls-area {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center; /* Centrer les boutons */
            margin-bottom: 20px;
        }

        /* Playlist */
        .playlist-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .playlist-header {
            background-color: #f1f3f5;
            padding: 10px 15px;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .playlist-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        .playlist-item:hover { background-color: #f9f9f9; }
        
        /* Style pour la vid√©o en cours de lecture */
        .playlist-item.active {
            background-color: #e7f1ff;
            border-left: 4px solid #0d6efd;
        }

        .playlist-thumb {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 15px;
            background: #eee;
        }
        .playlist-info { flex-grow: 1; overflow: hidden; }
        .playlist-title { font-weight: 600; font-size: 0.95em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .playlist-desc { font-size: 0.8em; color: #666; }

        /* Chat & Sidebar */
        .sidebar-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .sidebar-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
        }
        .sidebar-body { padding: 15px; min-height: 150px; }

        /* Modale Recherche */
        .video-card-small {
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            border-radius: 6px;
            align-items: center;
            background: #fff;
        }
        .video-card-small img { width: 120px; height: auto; border-radius: 4px; }
        .video-card-info { flex-grow: 1; font-size: 0.9em; }
        .video-card-info h6 { margin: 0 0 5px 0; font-size: 1em; font-weight: bold; }
    </style>
    
    <title id="titre">Room - W2G</title>
</head>
<body class="mx-5 mx-md-4">
    
    <nav class="navbar container">
        <a class="navbar-brand" href="#">W2G</a>
        <div class="">
            <ul class="navbar-nav d-flex flex-row gap-3 align-items-center" id="nav-auth">
                
            </ul>
        </div>
    </nav>

    <section class="container justify-content-center">
        <h1 class="text-center">
            Room : Regardez ensemble !
        </h1>

		<p class="justify-content-center" id="room-name"></p>
		<p class="justify-content-center" id="room-id"></p>

        <div class="row">
            <div class="col-md-8 offset-md-2">
                <p class="text-center fs-4 mt-3">
                    Synchronisez votre visionnage avec vos amis. Partagez le lien de la room pour inviter d'autres personnes.
                </p>
            </div>
        </div>

        <div class="row mb-2">
            <div class="col-12 text-end">
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#searchModal">
                    üîç Ajouter une vid√©o
                </button>
            </div>
        </div>

    </section>

    <section class="container">
        <div class="row">
            <!-- Lecteur vid√©o principal -->
            <div class="col-lg-8">
                <div class="ratio ratio-16x9 mb-4">
                    <div id="player"></div>
                </div>
                <!-- Contr√¥les de lecture (simul√©s, √† synchroniser via JS/WebSockets) -->
                <div class="d-flex justify-content-center gap-3 mb-4">
                    <button class="btn btn-outline-secondary" onclick="playPrev()">‚èÆ Pr√©c</button>
                    <button class="btn btn-primary" id="playBtn"><i class="bi bi-play-fill"></i> Play</button>
                    <button class="btn btn-secondary" id="pauseBtn"><i class="bi bi-pause-fill"></i> Pause</button>
                    <button class="btn btn-info" id="syncBtn"><i class="bi bi-arrow-clockwise"></i> Synchroniser</button>
                    <button class="btn btn-outline-secondary" onclick="playNext()">Suiv ‚è≠</button>
                </div>
                <!-- Champ pour changer de vid√©o -->
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="videoUrl" placeholder="Collez l'URL d'une vid√©o YouTube ou s√©lectionnez dans la biblioth√®que">
                    <button class="btn btn-outline-secondary" id="loadVideoBtn">Charger</button>
                </div>

                <div class="playlist-card">
                    <div class="playlist-header">
                        <span>üìã Playlist</span>
                        <span class="badge bg-secondary" id="playlist-count">0 vid√©os</span>
                    </div>
                    <div id="playlist-list">
                        </div>
                </div>
            </div>
            
            <!-- Sidebar : Chat et participants -->
            <div class="col-lg-4">
                <!-- Liste des participants -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Participants (3)</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">Vous (H√¥te)</li>
                            <li class="list-group-item">Ami1</li>
                            <li class="list-group-item">Ami2</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Chat en temps r√©el -->
                <div class="card">
                    <div class="card-header">
                        <h5>Chat</h5>
                    </div>
                    <div class="card-body p-0">
                        <ul id="messages"
                            style="list-style:none; padding:10px; margin:0; height:300px; overflow-y:auto;">
                        </ul>
                    </div>

                    <div class="card-footer p-2">
                        <form id="form" class="d-flex gap-2">
                        <input id="input"
                                class="form-control"
                                autocomplete="off"
                                placeholder="Message..." />
                        <button class="btn btn-primary">Send</button>
                        </form>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="modal fade" id="searchModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rechercher une vid√©o YouTube</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="text" id="modalSearchInput" class="form-control" placeholder="Rechercher (ex: Jul)...">
                        <button class="btn btn-primary" onclick="performModalSearch()">Rechercher</button>
                    </div>
                    <div id="modalResultsContainer" style="max-height: 400px; overflow-y: auto;">
                        <p class="text-muted text-center">Les r√©sultats s'afficheront ici...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="container">
        <div>
            <hr>
        </div>
        <div class="container text-center py-4">
            <p>&copy; 2024 W2G. Tous droits r√©serv√©s.</p>
        </div>
    </footer>
    
    <!-- JS Files -->
    <script src="../assets/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="../assets/js/jquery.min.js"></script>
    <script src="../assets/js/jquery.sticky.js"></script>
     
    <script src="http://localhost:3004/socket.io/socket.io.js"></script>
    <script type="module" src="../assets/js/room.js"></script>
    <script type="module" src="../assets/js/chat.js"></script>
    <script src="../assets/js/auth-nav.js"></script>
	<script>
		//test
		const room = JSON.parse(localStorage.getItem('roomObject'));
		console.log(room.name, room.admin);
		document.getElementById("room-name").innerHTML = "Room "+room.name;
		document.getElementById("room-id").innerHTML = "id: "+room.id;
	</script>


    <script type="module">
        import {Video} from "../assets/js/model/Video.js"
        
        const SERVER_URL = 'http://localhost:3002/search'; 

        // --- 1. DONN√âES DE LA PLAYLIST (Fausses vid√©os par d√©faut) ---
        let playlist = [
            {
                id: 'M7lc1UVf-VE',
                title: 'Video par defaut',
                thumb: 'https://img.youtube.com/vi/rTwzswSVjbo/mqdefault.jpg'
            },
            {
                id: 'ePiF7BWB6_s',
                title: 'Pourquoi 0.1 + 0.2 = 0.30000000000000004 ?',
                thumb: 'https://i.ytimg.com/vi/ePiF7BWB6_s/default.jpg'
            }
        ];

        let currentIndex = 0; // On commence par la premi√®re vid√©o

        // --- 2. FONCTIONS DE GESTION DU LECTEUR ---

        // Appel√© au chargement de la page
        window.onload = function() {
            renderPlaylist(); // Afficher la liste
            loadVideoAtIndex(0); // Charger la premi√®re
        };

        function loadVideoAtIndex(index) {
            if (index < 0 || index >= playlist.length) return; // S√©curit√©

            currentIndex = index;
            const video = playlist[index];
            
            const video_ = new Video(video.id);
            window.player.loadVideo(video_);
            window.player.sendState("changeState");

            // Mise √† jour visuelle de la liste
            renderPlaylist();
        }

        // Bouton SUIVANT
        function playNext() {
            if (currentIndex < playlist.length - 1) {
                loadVideoAtIndex(currentIndex + 1);
            } else {
                alert("C'est la derni√®re vid√©o !");
            }
        }

        // Bouton PR√âC√âDENT
        function playPrev() {
            if (currentIndex > 0) {
                loadVideoAtIndex(currentIndex - 1);
            } else {
                alert("Vous √™tes au d√©but de la playlist.");
            }
        }

        // --- 3. GESTION DE L'AFFICHAGE DE LA PLAYLIST ---
        
        function renderPlaylist() {
            const listContainer = document.getElementById('playlist-list');
            const countLabel = document.getElementById('playlist-count');
            
            listContainer.innerHTML = ''; // On vide la liste actuelle
            countLabel.innerText = playlist.length + " vid√©os";

            playlist.forEach((video, index) => {
                // On v√©rifie si c'est la vid√©o active
                const isActive = (index === currentIndex) ? 'active' : '';
                const statusText = (index === currentIndex) ? '‚ñ∂ Lecture en cours' : 'En attente';

                const itemHTML = `
                    <div class="playlist-item ${isActive}" onclick="loadVideoAtIndex(${index})">
                        <img src="${video.thumb}" class="playlist-thumb" alt="thumb">
                        <div class="playlist-info">
                            <div class="playlist-title">${video.title}</div>
                            <div class="playlist-desc">${statusText}</div>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', itemHTML);
            });
        }

        // --- 4. RECHERCHE & AJOUT (Reste identique) ---
        async function performModalSearch() {
            const query = document.getElementById('modalSearchInput').value;
            const container = document.getElementById('modalResultsContainer');
            if (!query) return;
            container.innerHTML = '<div class="text-center p-3">Chargement...</div>';
            try {
                const response = await fetch(`${SERVER_URL}?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                displayModalResults(data.items);
            } catch (error) {
                console.error(error);
                container.innerHTML = `<p class="text-danger">Erreur: ${error.message}</p>`;
            }
        }

        function displayModalResults(videos) {
            const container = document.getElementById('modalResultsContainer');
            container.innerHTML = ''; 
            if (!videos || videos.length === 0) {
                container.innerHTML = '<p>Aucune vid√©o trouv√©e.</p>';
                return;
            }
            for (const item of videos) {
                if (item.id.kind !== 'youtube#video') continue;
                const title = item.snippet.title;
                const thumbnail = item.snippet.thumbnails.default.url;
                const videoId = item.id.videoId;
                const safeTitle = title.replace(/'/g, "\\'"); 

                const div = document.createElement('div');
                div.className = 'video-card-small';
                div.innerHTML = `
                    <img src="${thumbnail}" alt="miniature">
                    <div class="video-card-info">
                        <h6>${title}</h6>
                    </div>
                    <button class="btn btn-sm btn-success" onclick="addVideoToPlaylist('${videoId}', '${safeTitle}', '${thumbnail}')">
                        Ajouter
                    </button>
                `;
                container.appendChild(div);
            }
        }

        function addVideoToPlaylist(videoId, title, thumbnail) {
            // Ajouter au tableau JS
            playlist.push({ id: videoId, title: title, thumb: thumbnail });
            
            // Mettre √† jour l'affichage
            renderPlaylist();

            // Fermer la modale
            const modalElement = document.getElementById('searchModal');
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            modalInstance.hide();
            
            // Si c'√©tait la seule vid√©o (la liste √©tait vide avant), on la lance
            if (playlist.length === 1) {
                loadVideoAtIndex(0);
            }
        }

        window.loadVideoAtIndex = loadVideoAtIndex;
        window.playNext = playNext;
        window.playPrev = playPrev;
        window.performModalSearch = performModalSearch;
        window.addVideoToPlaylist = addVideoToPlaylist;
    </script>
</body>
</html>
